<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:hx-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>KI Wissen Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FIX: Korrekter HTMX Pfad -->
    <script src="https://unpkg.com/htmx.org"></script>

    <style>
        htmx-swapping {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
<div class="max-w-4xl mx-auto space-y-8">

    <!-- Bereich 1: Upload -->
    <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4">Neues Wissen hinzufÃ¼gen</h2>
        <!-- FIX: Pfad mit / am Anfang -->
        <form hx-post="/admin/upload"
              hx-encoding="multipart/form-data"
              hx-target="#upload-status"
              hx-on::after-request="if(event.detail.successful) { this.reset(); htmx.trigger('body', 'updateList'); }">

            <div class="flex items-center gap-4">
                <input type="file" name="file" accept=".pdf" class="border p-2 rounded w-full">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    Hochladen
                </button>
            </div>

            <div id="upload-status" class="mt-2 text-sm font-medium"></div>
        </form>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
        <h2 class="text-xl font-bold mb-4 text-blue-600 text-sm uppercase tracking-wider">Autoren-Biografien</h2>

        <!-- NEU: Der dedizierte KI-Speicher-Chat direkt bei den Autoren -->
        <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-100">
            <label class="block text-xs font-bold text-purple-700 uppercase mb-2">KI-Autor-Erfassung</label>
            <form hx-post="/admin/autor/chat"
                  hx-target="#chat-response"
                  hx-indicator="#chat-loading"
                  hx-on::after-request="this.reset(); htmx.trigger('body', 'updateAuthorList')">
                <div class="flex gap-2">
                    <input type="text" name="question" required
                           class="flex-1 border-2 border-purple-200 p-2 rounded-lg focus:border-purple-500 outline-none transition"
                           placeholder="Z.B.: Speichere Holger, er ist ein Experte fÃ¼r Chemie...">
                    <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-bold transition">
                        Speichern âœ¨
                    </button>
                </div>
            </form>
        </div>

        <!-- Platzhalter fÃ¼r das Editier-Formular -->
        <div id="edit-container" class="mb-6"></div>

        <div id="author-list-wrapper" hx-get="/admin/autoren/list" hx-trigger="load, updateAuthorList from:body">
            <div id="author-list" th:fragment="authorTable">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="p-3">Name</th>
                        <th class="p-3">Bio-Vorschau</th>
                        <th class="p-3 text-right">Aktion</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="autor : ${autoren}" class="border-b hover:bg-blue-50 transition">
                        <td class="p-3 font-bold" th:text="${autor.name}"></td>
                        <td class="p-3 text-sm text-gray-500" th:text="${#strings.abbreviate(autor.biografie, 60)}"></td>
                        <td class="p-3 text-right">
                            <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm"
                                    th:attr="hx-get='/admin/edit/' + ${autor.name}"
                                    hx-target="#edit-container">
                                Bio Editieren
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Bereich 2: Dokumentenliste -->
    <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl font-bold mb-4">KI-GedÃ¤chtnis</h2>
        <!-- FIX: hx-trigger hÃ¶rt auf das Body-Event -->
        <div id="doc-list-wrapper"
             hx-get="/admin/list"
             hx-trigger="load, updateList from:body">
            <div id="doc-list" th:fragment="docTable">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b">
                <tr>
                    <th class="p-3">Dateiname</th>
                    <th class="p-3">Chunks</th>
                    <th class="p-3">Zuletzt aktualisiert</th>
                    <th class="p-3">Aktion</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="doc : ${docs}" class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium" th:text="${doc.fileName}"></td>
                    <td class="p-3" th:text="${doc.chunkCount}"></td>
                    <td class="p-3 text-sm text-gray-500"
                        th:text="${doc.lastUpdated != null ? #temporals.format(doc.lastUpdated, 'dd.MM.yyyy') : 'Kein Datum'}">
                    </td>
                    <<td class="p-3 text-right flex gap-2 justify-end">
                        <button class="text-red-500 hover:text-red-700 font-medium"
                                th:attr="hx-delete='/admin/documents/' + ${doc.fileName}"
                                hx-confirm="MÃ¶chtest du dieses Dokument wirklich lÃ¶schen?"
                                hx-target="closest tr"
                                hx-swap="outerHTML swap:1s">
                            LÃ¶schen
                        </button>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(docs)}">
                    <td colspan="4" class="p-8 text-center text-gray-400 italic">Noch kein Wissen geladen...</td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </div>
    <!-- Bereich 3: Chat Interface -->
    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
        <h2 class="text-xl font-bold mb-4">Fragen an dein Wissen</h2>

        <!-- Hier landet die Antwort der KI -->
        <div id="chat-response" class="min-h-[100px] p-4 mb-4 bg-gray-50 rounded border prose max-w-none">
            <!-- Dieses Fragment wird vom Controller zurÃ¼ckgegeben -->
            <div th:fragment="chatResponse" class="animate-fade-in">
                <p class="text-gray-800" th:text="${response}"></p>
            </div>
            <p class="text-gray-400 italic">Stelle eine Frage zu deinen Dokumenten...</p>
        </div>

        <form hx-post="/admin/chat"
              hx-target="#chat-response"
              hx-indicator="#chat-loading"
              hx-on::after-request="this.querySelector('input').value=''">
            <!-- NEU: Sprach-Auswahl -->
            <select name="lang" class="border p-2 rounded bg-white shadow-sm focus:ring-blue-500">
                <option value="Deutsch">Deutsch ğŸ‡©ğŸ‡ª</option>
                <option value="English">English ğŸ‡ºğŸ‡¸</option>
                <option value="FranÃ§ais">FranÃ§ais ğŸ‡«ğŸ‡·</option>
                <option value="EspaÃ±ol">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
                <option value="Italiano">Italiano ğŸ‡®ğŸ‡¹</option>
            </select>
            <div class="flex gap-2">
                <input type="text" name="question" required
                       class="flex-1 border p-2 rounded shadow-sm focus:ring-blue-500"
                       placeholder="Z.B.: Wie skaliere ich die Datenbank?">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    Prompt
                </button>
            </div>
            <div class="flex justify-between items-center mt-2">
                <!-- Ein kleiner, dezenter Button unter dem Chat-Input -->
                <button hx-post="/admin/chat/clear"
                        hx-target="#chat-response"
                        hx-confirm="MÃ¶chtest du den bisherigen Chat-Verlauf wirklich lÃ¶schen?"
                        class="text-xs text-red-500 hover:text-red-700 flex items-center gap-1 transition">
                    <span>ğŸ—‘ï¸</span> Verlauf & Sprache zurÃ¼cksetzen
                </button>
            </div>
            <!-- Lade-Indikator fÃ¼r die KI-Gedenksekunde -->
            <div id="chat-loading" class="htmx-indicator mt-2 text-blue-600 flex items-center gap-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                <span class="text-sm font-medium">KI analysiert Dokumente...</span>
            </div>
        </form>
    </div>

</div>
<div th:fragment="editFragment" th:if="${autor != null}" id="edit-section" class="bg-white p-6 rounded-xl shadow-lg border-2 border-blue-500 mb-8">
    <h2 class="text-xl font-bold mb-4" th:text="'Bearbeite: ' + ${autor.name}"></h2>
    <!-- WICHTIG: hx-target="#doc-list-wrapper" damit nach dem Speichern die Liste aktualisiert wird -->
    <form th:attr="hx-put=@{/admin/autor/{name}(name=${autor.name})}"
          hx-target="#author-list-wrapper"
          hx-on::after-request="if(event.detail.successful) document.getElementById('edit-section').remove()">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Biografie</label>
                <textarea name="biografie" rows="6"
                          class="w-full border p-2 rounded shadow-sm focus:ring-blue-500"
                          th:text="${autor.biografie}"></textarea>
            </div>
            <div class="flex gap-2">
                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded">Speichern</button>
                <button type="button" onclick="document.getElementById('edit-section').remove()" class="bg-gray-400 text-white px-6 py-2 rounded">Abbrechen</button>
            </div>
        </div>
    </form>
</div>

</body>
</html>
